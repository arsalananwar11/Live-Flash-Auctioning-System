{% extends "shared/main.html" %} 

{% block page_body %}
<script src="{{ url_for('static', filename='js/websocket.js') }}" type="module"></script>
<script src="{{ url_for('static', filename='js/auction_details.js') }}" type="module"></script>
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/auction_details.css') }}"
/>

<main class="auction-page">
    <div class="product-info">
        {% if auction.images and auction.images|length > 0 %}
            <img src="data:image/jpeg;base64,{{ auction.images[0].base64 }}" alt="Product icon" class="product-icon" />
        {% else %}
            <img src="https://via.placeholder.com/150" alt="Product icon" class="product-icon" />
        {% endif %}
        <h2 class="auction-item">{{ auction.auction_item }}</h2>
    </div>
    {% if auction.images and auction.images|length > 1 %}
        <img src="data:image/jpeg;base64,{{ auction.images[1].base64 }}" alt="Product image" class="product-image" />
    {% else %}
        <img src="https://via.placeholder.com/300" alt="Product image" class="product-image" />
    {% endif %}
    
    <div class="product-details">
        <p class="auction-desc">
            {{ auction.auction_desc }}
        </p>
        <div class="time-remaining">Time Remaining</div>
        <div class="top-bid">Top Bid</div>
        <div class="time-frame">00:32:10</div>
        <div class="bid-frame">
            <span>$</span>
            <span>1200</span>
        </div>
        <h2>Remaining Time: <span id="remaining-time">Calculating...</span></h2>
    </div>

    <div class="leaderboard-container">
        <h3 class="leaderboard-title">Leaderboard</h3>
        <table class="leaderboard-table">
            <thead>
                <tr class="table-header">
                    <th class="table-cell"><div class="cell-content">Rank</div></th>
                    <th class="table-cell"><div class="cell-content">Username</div></th>
                    <th class="table-cell"><div class="cell-content">Bid</div></th>
                    <th class="table-cell"><div class="cell-content">Time</div></th>
                </tr>
            </thead>
            <tbody>
                <!-- Leaderboard entries will be populated here -->
            </tbody>
        </table>
    </div>
    
    <div class="bid-buttons">
        <!-- Bid buttons or forms can be added here -->
    </div>
</main>

<!-- <script>
  // Data passed from the backend
  const websocketUrl = "{{ websocket_url }}";
  const userId = "{{ user_id }}";
  const auctionId = "{{ auction_id }}";

  console.log("Connecting to WebSocket...");
  console.log(`Auction ID: ${auctionId}, User ID: ${userId}`);

  // Establish WebSocket connection
  const socket = new WebSocket(
    `${websocketUrl}?auction_id=${auctionId}&user_id=${userId}`
  );
</script> -->
<script type="module">
  import { AuctionWebSocket } from "../static/js/websocket.js";

  // Data passed from the backend
  const websocketUrl = "{{ websocket_url }}";
  const userId = "{{ user_id }}";
  const auctionId = "{{ auction_id }}";

  console.log("Initializing WebSocket...");
  const auctionSocket = new AuctionWebSocket(websocketUrl, auctionId, userId);
  auctionSocket.connect();

  // Expose the auctionSocket for further interactions (like bid placement)
  window.auctionSocket = auctionSocket;
</script>

<script>
    const socket = io.connect('http://localhost:5000');

    // Listen for the auction time update
    socket.on('auction_time_update', (data) => {
        const remainingTime = data.remaining_time;
        // Convert the time (in seconds) to minutes and seconds
        const minutes = Math.floor(remainingTime / 60);
        const seconds = Math.floor(remainingTime % 60);
        document.getElementById('remaining-time').textContent = `${minutes}:${seconds < 10 ? '0' + seconds : seconds}`;
    });

    // Emit join_auction event when the user joins the auction
    function joinAuction(auctionId, userId) {
        socket.emit('join_auction', {
            auction_id: auctionId,
            user_id: userId
        });
    }

    // Listen for auction end notification
    socket.on('auction_ended', (data) => {
        alert(data.message);
        document.getElementById('remaining-time').textContent = "Auction Ended";
    });

    // Clean up when the user leaves
    window.addEventListener('beforeunload', () => {
        socket.emit('leave_auction', { auction_id: "{{ auction.auction_id }}" });
    });
</script>
{% endblock %}
